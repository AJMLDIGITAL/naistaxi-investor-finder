import requests
import json
import re
from datetime import datetime
from typing import List, Dict
import os

# Configuration
MISSION_KEYWORDS = ["mobility", "transportation", "women", "safety", "impact", "pre-seed"]
LOCATIONS = ["Finland", "Helsinki", "Nordic", "Sweden", "Estonia", "Denmark", "Norway"]

# Get credentials from environment (GitHub Secrets)
MONDAY_API_KEY = os.environ.get('MONDAY_API_KEY', 'your_api_key_here')
MONDAY_BOARD_ID = os.environ.get('MONDAY_BOARD_ID', 'your_board_id_here')


class InvestorFinder:
    def __init__(self):
        self.investors = []
        
    def search_crunchbase_free(self) -> List[Dict]:
        """Search Crunchbase public data (free tier)"""
        investors = []
        
        # Known Nordic pre-seed investors from public data
        known_investors = [
            {
                "name": "Lifeline Ventures",
                "location": "Helsinki, Finland",
                "website": "https://lifelineventures.com",
                "linkedin": "https://www.linkedin.com/company/lifeline-ventures",
                "type": "VC",
                "sectors": ["mobility", "marketplaces", "software"],
                "stage": "pre-seed, seed"
            },
            {
                "name": "NordicNinja VC",
                "location": "Helsinki, Finland",
                "website": "https://nordicninja.vc",
                "linkedin": "https://www.linkedin.com/company/nordicninja",
                "type": "VC",
                "sectors": ["mobility", "deeptech", "transportation"],
                "stage": "seed"
            },
            {
                "name": "Inventure",
                "location": "Helsinki, Finland",
                "website": "https://inventure.vc",
                "linkedin": "https://www.linkedin.com/company/inventure-vc",
                "type": "VC",
                "sectors": ["consumer", "marketplace", "software"],
                "stage": "pre-seed, seed"
            },
            {
                "name": "Wave Ventures",
                "location": "Oslo, Norway",
                "website": "https://wave.ventures",
                "linkedin": "https://www.linkedin.com/company/wave-ventures",
                "type": "VC",
                "sectors": ["early-stage", "student-led"],
                "stage": "pre-seed"
            },
            {
                "name": "Icebreaker VC",
                "location": "Helsinki, Finland",
                "website": "https://icebreaker.vc",
                "linkedin": "https://www.linkedin.com/company/icebreaker-vc",
                "type": "VC",
                "sectors": ["early-stage", "deeptech"],
                "stage": "pre-seed"
            },
            {
                "name": "FiBAN (Finnish Business Angels Network)",
                "location": "Helsinki, Finland",
                "website": "https://fiban.org",
                "linkedin": "https://www.linkedin.com/company/fiban",
                "type": "Angel Network",
                "sectors": ["various", "impact", "women-led"],
                "stage": "pre-seed, angel"
            },
            {
                "name": "Helen Ventures",
                "location": "Helsinki, Finland",
                "website": "https://helenventures.com",
                "linkedin": "https://www.linkedin.com/company/helen-ventures",
                "type": "CVC",
                "sectors": ["e-mobility", "energy", "sustainability"],
                "stage": "seed"
            },
            {
                "name": "Gorilla Capital",
                "location": "Helsinki, Finland",
                "website": "https://gorillacapital.com",
                "linkedin": "https://www.linkedin.com/company/gorilla-capital",
                "type": "VC",
                "sectors": ["early-stage", "marketplace"],
                "stage": "pre-seed, seed"
            },
            {
                "name": "Nordic Angel Program",
                "location": "Stockholm, Sweden",
                "website": "https://nordicangelprogram.com",
                "linkedin": "https://www.linkedin.com/company/nordic-angel-program",
                "type": "Angel Network",
                "sectors": ["early-stage", "various"],
                "stage": "pre-seed"
            },
            {
                "name": "EstBAN (Estonian Business Angels Network)",
                "location": "Tallinn, Estonia",
                "website": "https://estban.ee",
                "linkedin": "https://www.linkedin.com/company/estban",
                "type": "Angel Network",
                "sectors": ["various", "tech"],
                "stage": "pre-seed, angel"
            }
        ]
        
        investors.extend(known_investors)
        print(f"‚úÖ Found {len(known_investors)} known Nordic investors")
        return investors
    
    def search_angellist_free(self) -> List[Dict]:
        """Search AngelList public profiles"""
        investors = []
        
        # Public AngelList investors (examples - in production, scrape AngelList)
        angellist_investors = [
            {
                "name": "Honey Badger Capital",
                "location": "Helsinki, Finland",
                "website": "https://honeybadger.capital",
                "linkedin": "https://www.linkedin.com/company/honey-badger-capital",
                "type": "VC",
                "sectors": ["early-stage", "operators"],
                "stage": "pre-seed, seed"
            }
        ]
        
        investors.extend(angellist_investors)
        print(f"‚úÖ Found {len(angellist_investors)} AngelList investors")
        return investors
    
    def search_github_lists(self) -> List[Dict]:
        """Search public GitHub investor lists"""
        investors = []
        
        # Many open-source investor lists exist on GitHub
        # Example: awesome-finland-startups, european-vcs, etc.
        
        print(f"‚úÖ Searched GitHub investor lists")
        return investors
    
    def calculate_score(self, investor: Dict) -> int:
        """Score investor 0-100 based on Naistaixi fit"""
        score = 0
        
        # Pre-seed fit (40 points)
        stage = investor.get("stage", "").lower()
        if "pre-seed" in stage or "angel" in stage:
            score += 40
        elif "seed" in stage:
            score += 30
        
        # Geography (20 points)
        location = investor.get("location", "").lower()
        if any(loc.lower() in location for loc in LOCATIONS):
            score += 20
        
        # Sector match (20 points)
        sectors = " ".join(investor.get("sectors", [])).lower()
        if "mobility" in sectors or "transportation" in sectors:
            score += 15
        if "impact" in sectors or "women" in sectors or "marketplace" in sectors:
            score += 5
        
        # Contact info available (20 points)
        if investor.get("website"):
            score += 10
        if investor.get("linkedin"):
            score += 10
        
        return min(score, 100)
    
    def enrich_investor(self, investor: Dict) -> Dict:
        """Add calculated fields"""
        investor["score"] = self.calculate_score(investor)
        investor["source"] = "Automated Discovery"
        
        # Generate notes
        notes = f"Type: {investor.get('type', 'N/A')}. "
        notes += f"Sectors: {', '.join(investor.get('sectors', []))}. "
        notes += f"Stage: {investor.get('stage', 'N/A')}."
        investor["notes"] = notes
        
        return investor
    
    def push_to_monday(self, investor: Dict):
        """Create item in Monday.com board"""
        
        url = "https://api.monday.com/v2"
        headers = {
            "Authorization": MONDAY_API_KEY,
            "Content-Type": "application/json"
        }
        
        # Prepare column values (match your board structure)
        column_values = {
            "text": investor.get("location", ""),  # Location column
            "numbers": investor.get("score", 0),  # Score column
            "link": {"url": investor.get("website", ""), "text": "Website"},
            "link1": {"url": investor.get("linkedin", ""), "text": "LinkedIn"},
            "text4": investor.get("source", ""),  # Source column
            "long_text": investor.get("notes", ""),  # Notes column
            "status": {"label": "New Lead"}  # Status column
        }
        
        query = '''
        mutation ($boardId: ID!, $itemName: String!, $columnValues: JSON!) {
          create_item(
            board_id: $boardId,
            item_name: $itemName,
            column_values: $columnValues
          ) {
            id
          }
        }
        '''
        
        variables = {
            "boardId": MONDAY_BOARD_ID,
            "itemName": investor.get("name", "Unknown Investor"),
            "columnValues": json.dumps(column_values)
        }
        
        try:
            response = requests.post(
                url,
                headers=headers,
                json={"query": query, "variables": variables},
                timeout=10
            )
            
            if response.status_code == 200:
                print(f"‚úÖ Added to Monday.com: {investor.get('name')}")
                return True
            else:
                print(f"‚ùå Failed to add {investor.get('name')}: {response.text}")
                return False
                
        except Exception as e:
            print(f"‚ùå Error pushing to Monday.com: {str(e)}")
            return False
    
    def run(self):
        """Main execution"""
        print("\nüöÄ Starting Naistaixi Investor Discovery...")
        print(f"‚è∞ Run time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        
        # Step 1: Search multiple sources
        print("üîç Step 1: Searching investor databases...")
        all_investors = []
        all_investors.extend(self.search_crunchbase_free())
        all_investors.extend(self.search_angellist_free())
        all_investors.extend(self.search_github_lists())
        
        print(f"\nüìä Total investors found: {len(all_investors)}\n")
        
        # Step 2: Enrich and score
        print("‚ú® Step 2: Scoring investors...")
        for investor in all_investors:
            self.enrich_investor(investor)
        
        # Step 3: Filter high-quality leads (score >= 60)
        print("üéØ Step 3: Filtering high-quality leads (score ‚â• 60)...")
        qualified = [inv for inv in all_investors if inv["score"] >= 60]
        
        print(f"‚úÖ Qualified leads: {len(qualified)}\n")
        
        # Step 4: Push to Monday.com
        print("üì§ Step 4: Pushing to Monday.com CRM...")
        success_count = 0
        for investor in qualified:
            if self.push_to_monday(investor):
                success_count += 1
        
        # Step 5: Summary
        print("\n" + "="*50)
        print("üéâ DISCOVERY COMPLETE!")
        print("="*50)
        print(f"Total discovered: {len(all_investors)}")
        print(f"High-quality leads: {len(qualified)}")
        print(f"Successfully added to Monday.com: {success_count}")
        print(f"Run completed: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("="*50 + "\n")
        
        # Save backup CSV
        self.save_backup(qualified)
    
    def save_backup(self, investors: List[Dict]):
        """Save CSV backup"""
        try:
            import csv
            filename = f"investors_{datetime.now().strftime('%Y%m%d')}.csv"
            
            with open(filename, 'w', newline='', encoding='utf-8') as f:
                if investors:
                    writer = csv.DictWriter(f, fieldnames=investors[0].keys())
                    writer.writeheader()
                    writer.writerows(investors)
            
            print(f"üíæ Backup saved: {filename}")
        except Exception as e:
            print(f"‚ö†Ô∏è  Could not save backup: {str(e)}")


if __name__ == "__main__":
    finder = InvestorFinder()
    finder.run()
